<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid-filter.html">
<link rel="import" href="../bower_components/vaadin-lumo-styles/color.html">
<link rel="import" href="../bower_components/vaadin-lumo-styles/sizing.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button-light.html">
<link rel="import" href="date-helpers.html">
<link rel="import" href="data/store.html">
<link rel="import" href="icons.html">

<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="constant.html">

<!-- <link rel="import" href="../bower_components/iron-scroll-threshold/iron-scroll-threshold.html"> -->

<dom-module id="expenses-list">
  <template>
    <style>
      :host {
        position: relative;
        display: flex;
        flex-direction: column;
      }
      
      :host input{
        display: none
      }
      #add-button {
        position: absolute;
        height: var(--lumo-size-xl);
        width: var(--lumo-size-xl);
        right: 32px;
        bottom: 32px;
        z-index: 1;
        background: var(--lumo-error-color);
        color: var(--lumo-error-contrast-color);
        box-shadow: var(--lumo-box-shadow-m);
        border-radius: 50%;
      }

      #expenses {
        flex: auto;
        height: 0.001px;
        border: 0;
      }

      vaadin-grid .status {
        text-transform: capitalize;
      }

      vaadin-grid .status-new, vaadin-grid .status-failed, vaadin-grid .status-invalid {
        color: var(--lumo-error-color);
        font-weight: 500;
      }

      vaadin-grid .status-in_progress, vaadin-grid .status-error, vaadin-grid .status-already {
        font-weight: 500;
        font-style: italic;
        text-transform: capitalize;
      }

      vaadin-grid .total {
        text-align: right;
      }

      vaadin-grid#expenses .cell.last {
        padding-right: 24px;
      }

      vaadin-grid#expenses .numeric {
        text-align: right;
      }

      vaadin-grid#expenses .comment {
        text-overflow: ellipsis;
      }
    </style>


    <vaadin-grid id="expenses" active-item="{{activeItem}}"
       >

      <vaadin-grid-column frozen>
        <template class="header">Action</template>
        <template>
          <button on-click="_reprint"
              invoice-number="[[item.txnTraceNumber]]">Print</button>
        </template>
      </vaadin-grid-column>
      
      <vaadin-grid-column width="11em" frozen>
        <template class="header">
          <vaadin-grid-sorter path="txnTransactionDate" direction="DESC">
            <div class="header-cell">
              Date
            </div>
          </vaadin-grid-sorter>
        </template>
        <template>
          [[_formatDate(item.txnTransactionDate)]]
        </template>
      </vaadin-grid-column>

      <vaadin-grid-column width="9em">
        <template class="header">
          <vaadin-grid-sorter path="txnUniqueCode" class="numeric">
            <div class="header-cell">
              Voucher Code
            </div>
          </vaadin-grid-sorter>
          <vaadin-grid-filter aria-label="#" path="txnMid" value$="[[mid]]">
              <input placeholder="Voucher #" value$="[[mid]]" focus-target>
          </vaadin-grid-filter>
          <vaadin-grid-filter aria-label="#" path="txnTid" value="[[tid]]">
              <input placeholder="Voucher #" value="[[tid]]" focus-target>
          </vaadin-grid-filter>
          <vaadin-grid-filter aria-label="#" path="txnUniqueCode" value="[[_filterVoucher]]">
              <input placeholder="Voucher #" value="{{_filterVoucher::input}}" id="voucherCode" focus-target>
          </vaadin-grid-filter>
          <vaadin-grid-filter aria-label="#" path="txnStartTransactionDate" value="[[_filterStart]]">
              <input placeholder="Voucher #" value="{{_filterStart::input}}" id="startDate" focus-target>
          </vaadin-grid-filter>
          <vaadin-grid-filter aria-label="#" path="txnEndTransactionDate" value="[[_filterEnd]]">
              <input placeholder="Voucher #" value="{{_filterEnd::input}}" id="endDate" focus-target>
          </vaadin-grid-filter>
          <vaadin-grid-filter aria-label="#" path="txnTraceNumber" value="[[_filterInvoice]]">
              <input placeholder="Voucher #" value="{{_filterInvoice::input}}" id="invoiceNumber" focus-target>
          </vaadin-grid-filter>

        </template>
        <template>
           <span class="total">[[item.txnUniqueCode]] </span><!--[[_formatTotal(item.total)]]</span> -->
        </template>
      </vaadin-grid-column>

      <vaadin-grid-column width="9em" flex-grow="2">
        <template class="header">
          <!-- <vaadin-grid-sorter path="txnLogDetails[0].txnRedeemLabel"> -->
            <div class="header-cell">
              Voucher Name
            </div>
          <!-- </vaadin-grid-sorter> -->
        </template>
        <template>
          [[item.txnLogDetails.0.txnRedeemLabel]]
        </template>
      </vaadin-grid-column>

      <vaadin-grid-column width="6em">
        <template class="header">
          <vaadin-grid-sorter path="txnOriginalAmount" class="numeric">
            <div class="header-cell">
              Original Amount
            </div>
          </vaadin-grid-sorter>
        </template>
        <template>
           <span class="total">[[item.txnOriginalAmount]] </span><!--[[_formatTotal(item.total)]]</span> -->
        </template>
      </vaadin-grid-column>

      <vaadin-grid-column width="6em">
        <template class="header">
          <!-- <vaadin-grid-sorter path="txnLogDetails[0].txnRedeemValue" class="numeric"> -->
            <div class="header-cell">
              Voucher Amount
            </div>
          <!-- </vaadin-grid-sorter> -->
        </template>
        <template>
           <span class="total">[[item.txnLogDetails.0.txnRedeemValue]] </span><!--[[_formatTotal(item.total)]]</span> -->
        </template>
      </vaadin-grid-column>

      <vaadin-grid-column width="6em">
        <template class="header">
          <vaadin-grid-sorter path="txnRemainingAmount" class="numeric">
            <div class="header-cell">
              Remaining Amount
            </div>
          </vaadin-grid-sorter>
        </template>
        <template>
           <span class="total">[[item.txnLogDetails.0.txnAdjustedAmount]] </span><!--[[_formatTotal(item.total)]]</span> -->
        </template>
      </vaadin-grid-column>

      <vaadin-grid-column width="8em">
          <template class="header">
            <vaadin-grid-sorter path="txnTraceNumber">
              <div class="header-cell">
                Invoice #
              </div>
            </vaadin-grid-sorter>
          </template>
          <template>
            <span> [[item.txnTraceNumber]]  </span> 
          </template>
        </vaadin-grid-column>

<!--
      <vaadin-grid-column width="8em">
        <template class="header">
          <vaadin-grid-sorter path="status">
            <div class="header-cell">
              Status
            </div>
          </vaadin-grid-sorter>
        </template>
        <template>
          <span class$="status-[[item.status]] status"> [[item.txnResponseDetail]]  </span> <!--[[_formatStatus(item.status)]]
        </template>
      </vaadin-grid-column>
 -->

    </vaadin-grid>

    <iron-ajax id="txnInfoFetcher" 
          url=[[fetchUrl]] method="get" 
          params="[[queryParams]]"
          headers='{"Content-Type": "application/json"}'
          on-response="eligibleResponse"
          on-error="onError"
          timeout=30000>
      </iron-ajax>
  </template>
  <script>
    (function() {
      /**
       * @memberof ExpenseManager
       */
      class ExpensesListElement extends ExpenseManager.ReduxMixin(Polymer.Element) {
        static get is() {
          return 'expenses-list';
        }

        static get properties() {
          return {
            /**
             * The list of expenses.
             * @type {Array}
             */
            expenses: {
              type: Array,
              statePath: ExpenseManager.select.expenses
            },

            /**
             * The selected expense object.
             * @type {Array}
             */
            activeItem: {
              observer: '_activeItemChanged'
            },

            page: {
              type: Number,
              statePath: 'uiState.pagination'
            },
            pageLoad: {
              type: Boolean,
              statePath: 'uiState.page_loading'
            },
            burnedStuff: {
              type: Array,
              // statePath: 'burned'
            },
            dataProvider: {
              type: Array,
              /*
              value: () => {
                const _this = this;
                return (params, callback) => {
                  const items = Array.apply(null, {length: 20})
                    .map((item, index) => getJSON('http://randomuser.me?index=' + 0));//(index + params.page * params.pageSize)));
                  _this.loading = true;
                  setTimeout(() => {
                    callback(items);
                    _this.loading = false;
                  }, 500);
                };
              }
             */
              
            },
            _loading: {
              type: Boolean
            },
            filters: {
              type: Object,
              statePath: 'filters',
              observer: '_detectFilterChange'
            },
            mid: {
              type: String,
              statePath: 'user.data.mid'
            },
            tid: {
              type: String,
              statePath: 'user.data.tid'
            },
            fetchUrl: {
              type: String,
              value: () => constant.url.staging.list_vouchers
            },
            queryParams: {
              type: Object,
              value: () => {
                return {
                  page: 0,
                  size: 10,
                  sort: "txnTransactionDate,DESC"
                }
              }
            }
          };
        }

        appendRows(loaded){
            this.dispatch('appendBurned', loaded)
        }
        constructor() {
          super();
          this.prop = 'expenses-list'          
        }

        ready(){
          super.ready();
          
          // we can stitch it to a method! 
          // this.addEventListener('state-changed', this._detectFilterChangeCustomEvent);

          this.$.expenses.size = 100;
          this.$.expenses.pageSize = 10;
          this.$.expenses.dataProvider = function(params, callback) {
            var xhr = new XMLHttpRequest();
            var $this = this;
            xhr.onload = function() {
                callback(JSON.parse(xhr.responseText).content);
            };
            
            var url = constant.url.staging.list_vouchers + '?size=' + params.pageSize + '&page=' + params.page //+ '&sort=txnTransactionDate,DESC' //+ this.customFilters; //'https://demo.vaadin.com/demo-data/1.0/people?index=' + index + '&count=' + params.pageSize;

            //var url = '../src/data/manual-redeem.json?'; //'https://demo.vaadin.com/demo-data/1.0/people?index=' + index + '&count=' + params.pageSize;

            // `params.filters` format: [{path: 'lastName', direction: 'asc'}, ...];
            params.filters.forEach(function(filter) {
              if (filter.value!='') //remove the unneceseary filter
               url += '&' + filter.path + '=' + encodeURIComponent(filter.value);
            });
            
            // `params.sortOrders` format: [{path: 'lastName', direction: 'asc'}, ...];
            params.sortOrders.forEach(function(sort) {
              url += `&sort=${sort.path},${sort.direction}`;
            });

            xhr.open('GET', url, true);
            xhr.send();
          };
         
        }
        
        _detectFilterChangeCustomEvent(event){
          const state = event.detail;
          let lastFilters = {};

          if (JSON.stringify(state.filters) !== JSON.stringify(this.srcFilters)) {
            this._filterVoucher = "73255656532" //state.filters.uniqueCode;
            lastFilters = state.filters;
          }

          this.refreshDataProvider()
        }
        

        refreshDataProvider(){
          //effin hard to 'slip-in' a variable so dataProvider function can get it
          this.$.expenses.customFilters = this._getParams();

          this.$.expenses.dataProvider = function(params, callback) {
            var xhr = new XMLHttpRequest();
            xhr.onload = function() {
            };
            // var index = params.page * params.pageSize;

            var url = constant.url.staging.list_vouchers + '?size=20&page=' + params.page //+ this.customFilters; //'https://demo.vaadin.com/demo-data/1.0/people?index=' + index + '&count=' + params.pageSize;
            console.log(url)
            xhr.open('GET', url, true);
            xhr.send();
          };
        }

        _detectFilterChange(){
          this.$.expenses.customFilters = this._getParams();
          console.log('=========== ' + this.$.expenses.customFilters)
          console.log(this.$.expenses.dataProvider)

          if (this.filters.applyUpdate){

            // change the inputbox for filters
            if ( this.filters.specificVoucher!=null)
              this._filterVoucher = this.filters.specificVoucher

            if(this.filters.filters.txnStartTransactionDate!=undefined )
              if(this.filters.filters.txnStartTransactionDate!='')
                this._filterStart = this.filters.filters.txnStartTransactionDate + ' 00:00:00'
              else 
                this._filterStart = ''
              
            if(this.filters.filters.txnEndTransactionDate!=undefined )
              if(this.filters.filters.txnStartTransactionDate!='')
                this._filterEnd = this.filters.filters.txnEndTransactionDate + ' 23:59:59'
              else
                this._filterEnd = ''

            if(this.filters.filters.txnTraceNumber!=undefined)
              this._filterInvoice = this.filters.filters.txnTraceNumber
            
            this.dispatch('updateDone')
          }

        }

        _getParams() {
          this.filters.sort = (this.filters.sort==undefined) ? "txnTransactionDate,DESC" : this.filters.sort;
          console.log(this.filters)
          
          let params = ""
          Object.entries(this.filters).forEach((entry) => {
              const [key, value] = entry;
              params += `&${key}=${value}`;
              //console.log(`${key}: ${value}`);
          });

          return params;
        }


        _reprint(e) {
          console.log('fetching TxnNumber #:'+ e.target.invoiceNumber)
          console.log(this.queryParams)
          this.queryParams.txnTraceNumber = e.target.invoiceNumber;
          this.$.txnInfoFetcher.generateRequest();
        }

        eligibleResponse(result){
          console.log(result.detail.response.content);
          this.createCacheFromFetch(result.detail.response.content);
        }

        onError(e){
          console.log(e)
          console.log(e.target.lastRequest.xhr.status)
          console.log(detail.error); //the error object
          console.log(detail.request.status); //the status code
          console.log(detail.request.statusText);  //the error status text
        }

        createCacheFromFetch(trans){
          // destructure the transaction info
          var selectedTrx = {};
          selectedTrx.vouchers = [];

          for (var l in trans){
             // getting the 1st transaction (real original amount)
             if (l==0){
               selectedTrx.trxAmount = trans[l].txnOriginalAmount;
               selectedTrx.trxNumber = trans[l].txnTraceNumber;
               selectedTrx.merchantName = trans[l].txnMerchantName;
               selectedTrx.burnDate = trans[l].txnTransactionDate;
               selectedTrx.storeName = trans[l].txnStoreName;
             }

             // getting the last remaining amount (from the lastest trans member)
             if(l==(trans.length-1))
              selectedTrx.remaining = numeral(trans[l].txnRemainingAmount).format(0.0);
            
             // routine getting each vouchers' info..
             selectedTrx.vouchers[l] = {}
             selectedTrx.vouchers[l].uniqueCode = trans[l].txnUniqueCode;
             selectedTrx.vouchers[l].voucherType = trans[l].txnLogDetails[0].txnRedeemLabel;
             if(trans[l].txnLogDetails[0].txnRedeemType == 'VOUCHER')
                selectedTrx.vouchers[l].voucherAmount = trans[l].txnLogDetails[0].txnRedeemValue;
             else
                selectedTrx.vouchers[l].voucherAmount = 0;
          }

          /* ========= OLD LOGIC (before change on web-api listinfo) ========
          // should choose the first Invoice (if happens to be more than one transactions)
          var t = trans[0];
          selectedTrx.trxAmount = t.txnOriginalAmount;
          selectedTrx.trxNumber = t.txnTraceNumber;
          selectedTrx.remaining = numeral(t.txnRemainingAmount).format(0.0);
          selectedTrx.storeName = t.txnStoreName;
          selectedTrx.merchantName = t.txnMerchantName;
          selectedTrx.burnDate = t.txnTransactionDate;

          //container for burned voucher(s) info..
          selectedTrx.vouchers = [];
          for (var k in t.txnLogDetails ){
            selectedTrx.vouchers[k] = {};
            selectedTrx.vouchers[k].uniqueCode = t.txnLogDetails[k].txnRedeemCode;
            selectedTrx.vouchers[k].voucherType = t.txnLogDetails[k].txnRedeemLabel;
            //adding filter to not add up discount amount for Coupon type
            if (t.txnLogDetails[k].txnRedeemType == 'VOUCHER')
              selectedTrx.vouchers[k].voucherAmount = t.txnLogDetails[k].txnRedeemValue;
            else
              selectedTrx.vouchers[k].voucherAmount = 0;
          }
          */
          console.log(selectedTrx)
          this.dispatch('addLastTransaction', selectedTrx);
          
          setTimeout( () => {
              this.dispatch('showREreceipt')
          }, 500);
        }

        _showExpenseEditor() {
          this.dispatch('editExpense');
        }

        _showInfoDialog() {
          this.dispatch('showInfoDialog');
        }

        nextPage() {
          this.dispatch('nextPage');
        }

        /**
         * @param {Object|null} expense the selected expense, if any.
         */
        _activeItemChanged(voucher) {
          console.log(voucher)
          // disable list-clicking
          // if (this.expenses && this.expenses.length > 0) { // don't trigger on init
          //   this.$.expenses.selectedItems = expense ? [expense] : [];
          //   this.dispatch('editExpense', expense);
          // }
        }

        /**
         * @param {number} total an expense amount to format.
         * @return {string} a formatted amount.
         */
        _formatTotal(total) {
          if (total) {
            return 'Rp ' + total.toFixed(2);
          }
        }

        /**
         * @param {string} status an expense status to format.
         * @return {string} a formatted status.
         */
        _formatStatus(status) {
          if (status) {
            return status.replace('_', ' ');
          }
        }

        /**
         * @param {string} date an expense date to format.
         * @return {string} a formatted date.
         */
        _formatDate(date) {
          if (date) {
            return window.ExpenseManager.dateHelpers.format(date);
          }
        }

        loadMoreVouchers(){
          // alert('reach bottom!')
        }
      }

      customElements.define(ExpensesListElement.is, ExpensesListElement);

      /**
       * @namespace ExpenseManager
       */
      window.ExpenseManager = window.ExpenseManager || {};
      ExpenseManager.ExpensesListElement = ExpensesListElement;
    })();
  </script>
</dom-module>
