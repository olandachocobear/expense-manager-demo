<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="history-panel.html">
<link rel="import" href="expenses-list.html">
<link rel="import" href="responsive-mixin.html">

<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="constant.html">

<dom-module id="content-panel">
  <template>
    <style>
      :host {
        display: flex;
        height: 100%;
      }

      :host([tablet]) {
        flex-direction: column;
      }

      expenses-list {
        flex: 1;
        height: 100%;
      }

      history-panel {
        box-shadow: var(--lumo-shade-50pct) 6px 0 16px -10px inset;
        z-index: 1;
      }

      history-panel[tablet] {
        box-shadow: var(--lumo-shade-50pct) 0 6px 16px -10px inset;
      }
    </style>

    <expenses-list lists=[[rawResult]]></expenses-list>
    <!-- <history-panel phone="[[phone]]" tablet="[[tablet]]"></history-panel> -->
  
    <iron-ajax id="vouchersLoader" auto
          url=[[ironUrl]] method="get"
          params='{{_getParams()}}'
          headers='{
            "JSESSIONID": "uIqMlmiwuHozqt8RSuttLy4gc9LtN6"
          }'
          on-response="_displayList">
      </iron-ajax>
  </template>
  <script>
    (function() {
      /**
       * @memberof ExpenseManager
       * @mixes ExpenseManager.ResponsiveMixin
       */
      class ContentPanelElement extends ExpenseManager.ReduxMixin(ExpenseManager.ResponsiveMixin(Polymer.Element)) {
        static get is() {
          return 'content-panel';
        }

        static get properties() {
          return {
            tid: {
              type: String
            },
            mid: {
              type: String
            },
            ironUrl: {
              type: String,
              value: () => constant.url.dev.list_vouchers
            },
            currentPage: {
              type: String,
              // value: () => 0,
              statePath: 'uiState.pagination',
              observer: "_pageUpdated"
            },
            rawResult: {
              type: Array,
              // statePath: 'burned',
              // observer: '_listChanged'
              // value: () => ExpenseManager.select.listVouchers
              statePath: ExpenseManager.select.listVouchers
            },
            newResponseCode: {
              type: String,
              statePath: 'errors.code',
              observer: '_checkIfNewTransaction'
            },
            userDetails: {
              type: Object,
              statePath: 'user.data.mid'
            },
            userSess: {
              type: String,
              statePath: 'user.session.jsess'
            },
            search: {
              type: String,
              statePath: 'filters.specificVoucher',
              observer: 'searchChanged'
            }
          }
        }
        
        searchChanged() {
          if(this.search!='')
              this.$.vouchersLoader.params.txnUniqueCode= this.search;
          else
              delete this.$.vouchersLoader.params.txnUniqueCode
          
          this.updateList()
        }

        _getParams() {
          return ({
              txnMid: "GOCAFE000000001",// this.tid,
              txnTid: "GOCAFE01", //this.mid,
              page: (this.currentPage==undefined) ? 0: this.currentPage,
              size: 100,
              sort: "txnTransactionDate,DESC"
          })
        }

        _pageUpdated() {
          console.log('Loading for page #' + this.currentPage);
          this.$.vouchersLoader.params.page = this.currentPage;
          
          // should be Immediately, or wait for button?
          this.updateList()
        }

        _checkIfNewTransaction() {
          if (this.newResponseCode == 200)
            this.$.new
        }

        updateList() {
          this.$.vouchersLoader.generateRequest();
        }

        _displayList(result) {
          var res = result.detail.response;
          var temp = [];
          
          for(var i=0; i<res.content.length;i++)
            temp.push(res.content[i])
          // if(this.queryResult)
          //   this.queryResult = this.queryResult.push(res.content);
          // else
          //   this.queryResult = res.content

          console.log(temp);

          if(this.$.vouchersLoader.params.page==0)
            this.dispatch('insertBurned', temp)
          else
            this.dispatch('appendBurned', temp)
        }
      }

      customElements.define(ContentPanelElement.is, ContentPanelElement);

      /**
       * @namespace ExpenseManager
       */
      window.ExpenseManager = window.ExpenseManager || {};
      ExpenseManager.ContentPanelElement = ContentPanelElement;
    })();
  </script>
</dom-module>
