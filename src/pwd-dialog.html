<link rel="import" href="../bower_components/polymer/polymer-element.html">

<link rel="import" href="../bower_components/vaadin-button/vaadin-button.html">
<link rel="import" href="../bower_components/vaadin-lumo-styles/color.html">
<link rel="import" href="../bower_components/vaadin-lumo-styles/spacing.html">
<link rel="import" href="../bower_components/vaadin-lumo-styles/typography.html">

<link rel="import" href="../bower_components/vaadin-lumo-styles/icons.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/vaadin-text-field/vaadin-password-field.html">

<link rel="import" href="../bower_components/iron-swipeable-pages/iron-swipeable-pages.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<!-- ======================================================================= -->
<!-- Encrypt Library (for Password) -->
<!-- ======================================================================= -->
<script src="js/sha256.js"></script>
<script src="js/hmac-sha256.js"></script>
<script src="js/enc-base64-min.js"></script>

<dom-module id="pwd-dialog">
  <template>
    <style>
      
    </style>


    <confirm-dialog id="pwdDialog" 
        on-result="closePwdDialog"
        background="#e6e6e6" 
        modal=true
        step-msg="OK"
        step-dialog
        checking={{checkStatus}}>

        <div style=padding-right:20px;>
                
            <iron-swipeable-pages 
                id="pwdDialogPages"
                on-selected-changed="_onSelectedChanged"
                selected="{{currentPage}}"
                style="height:260px; margin-top: -11px">

                <div id="pwdFormPage" 
                    style="padding: 0 15px 0 0">
                    <center>
                        <h2 style="text-decoration: underline;
                            color:#444;
                            font-size:22px;
                            margin-top:5px">Ubah Password</h2>
                        <br><br>
                    
                        <vaadin-password-field whiteBg id="oldPwd" theme="align-left" 
                            value="{{oldPwd}}" label="Password Lama:" 
                            style="--lumo-text-field-size: var(--lumo-size-l);
                                    font-size: var(--lumo-font-size-xl);
                                    margin-top:-33px;
                                    --lumo-font-size-xl: 28px;
                                    --lumo-font-family: Arial;
                                    font-weight: bolder;
                                    --lumo-secondary-text-color: #4d4d4d;
                                    width:100%"
                            on-keyup="changeOldPwd">
                            <div slot="prefix"></div>
                        </vaadin-password-field>
                        <br><br><br><br>
                        
                        <vaadin-password-field whiteBg id="newPwd" theme="align-left" 
                            value="{{newPwd}}" label="Password Baru:" 
                            style="--lumo-text-field-size: var(--lumo-size-l);
                                font-size: var(--lumo-font-size-xl);
                                margin-top:-52px;
                                --lumo-font-size-xl: 28px;
                                --lumo-font-family: Arial;
                                font-weight: bolder;
                                --lumo-secondary-text-color: #4d4d4d;
                                width:100%"
                            on-keyup="changeNewPwd">
                            <div slot="prefix"></div>
                        </vaadin-text-field>
                    </center>
                </div>  
                
                <div id="pwdResultPage" style="overflow: hidden">
                    <center>
                    <h3 style=margin-top:-3px;color:#444;font-size:17px> Alright.. Your password has changed!</h3>
                        <img src="https://i.gifer.com/55tE.gif"
                            style="margin-top:4px"
                            height=240>                    
                    </center>
                </div>  
            </iron-swipeable-pages>
    
        </div>
    
        
        
    </confirm-dialog>
    

    <iron-ajax id="processChangePwd" 
          url={{ironUrl}} method="post" 
          body="{{bodyRequest}}"
          headers='{{header}}'
          on-response="eligibleResponse"
          on-error="onError"
          timeout=30000>
      </iron-ajax>

  </template>

  <script>
    (function() {
      /**
       * @memberof ExpenseManager
       */
      class PwdDialogElement extends ExpenseManager.ReduxMixin(Polymer.Element) {
        static get is() {
          return 'pwd-dialog';
        }
        
        static get properties() {
          return {
              shown: {
                type: Boolean,
                observer: '_toggleMe'
              },
              ironUrl: {
                type: String,
                value: () => CONST.URL.CHANGE_PWD
              },
              passwords: {
                type: Object,
                statePath: 'password'
              },
              bodyRequest: {
                type: Object
              },
              passwords: {
                type: Object,
                statePath: 'password',
                observer: '_updateBodyRequest'
              },
              username: {
                  type: String,
                  statePath: 'user.data.username'
              },
              session: {
                  type: String,
                  statePath: 'user.session.jsess'
              },
              header: {
                  type: Object
              },
              currentPage: {
                  type: String,
                  value: () => 0
              },
              changeSuccess: {
                  type: Boolean,
                  statePath: 'passwords.changeSuccess',
                  observer: 'changePage'
              },
              checking: {
                  type: Boolean,
                  notify: true,
                  observer: 'checkingStatus'
              },
              checkStatus: {
                  type: Boolean,
                  notify: true,
                  value: () => false,
                  observer: 'checkingCommenced'
              }
          }
        }
        
        ready() {
            super.ready();

            this.header = {
                'Content-Type': 'application/json',
                'JSESSIONID': this.session
            }
        }
        
        _toggleMe() {
            if (this.shown){
                this.$.pwdDialog.show({
                delay: 10,
                confirm: "OK",
                cancel: "Batal"
                })
            }
        }

        changePage() {
            // if(this.changeSuccess)
                // this.$.pwdDialogPages._selectPage('pwdResultPage')
                this.$.pwdDialogPages.selected = 1;
                this.$.pwdDialog.removeAttribute('step-dialog');
        }
        
        checkingCommenced() {
            console.log(this.checkStatus);
            // simulate change Pass success
            if(this.checkStatus) {
                let $this = this;
                setTimeout( _ => {
                    $this.dispatch('pwdChangedSuccess', true);
                    $this.changeSuccess = false;
                }, 2000);
            }
        }
        popChangePwd() {
          this.dispatch('togglePwdDialog', !this.showPwdChange);
        }

        changeOldPwd() {
            this.dispatch('updateOldPassword', this.calculatePasswordHash(this.oldPwd, this.username))
        }

        changeNewPwd() {
            this.dispatch('updateNewPassword', this.calculatePasswordHash(this.newPwd, this.username))
        }

        closePwdDialog(result) {
            this.dispatch('togglePwdDialog', false);

            if(result.detail==true){ // if click 'Print Receipt'
                this.$.processChangePwd.generateRequest();
            }
        }
        
        _updateBodyRequest() {
            this.bodyRequest = {
                oldPassword: this.passwords.currentPwd,
                newPassword: this.passwords.newPwd,
                username: this.username
            }
        }

        calculatePasswordHash(password, username) {
            var hashedPass = CryptoJS.SHA256(password.toString()).toString(CryptoJS.enc.Hex);
            var secret = CryptoJS.SHA256(username).toString(CryptoJS.enc.Hex);
            var hash = CryptoJS.HmacSHA256(hashedPass, secret);
            var hashInBase64 = CryptoJS.enc.Base64.stringify(hash);
            return hashInBase64;
        };
      }

      customElements.define(PwdDialogElement.is, PwdDialogElement);

      /**
       * @namespace ExpenseManager
       */
      window.ExpenseManager = window.ExpenseManager || {};
      ExpenseManager.PwdDialogElement = PwdDialogElement;
    })();
  </script>
</dom-module>
