<link rel="import" href="constants.html">
<script src="../../node_modules/reselect/dist/reselect.js"></script>
<link rel="import" href="../date-helpers.html">

<script>
  (() => {

    const getExpenses = state => state.expenses.expenses;
    const getFilters = state => state.filters.filters;
    const getVouchers = state => state.lastTrx.vouchers;
    const helpers = ExpenseManager.dateHelpers;

    const expenses = 0/*Reselect.createSelector(
      [getExpenses, getFilters],
      (expenses, filters) => {

        const merchant = filters.merchant;
        const min = filters.min;
        const max = filters.max;
        const status = filters.status;
        const start = filters.start;
        const end = filters.end;
        
        if (expenses.length!=0)
          return expenses
            .filter(exp => !(merchant && exp.merchant.toUpperCase().indexOf(merchant.toUpperCase()) < 0))
            .filter(exp => !(min && exp.total < min))
            .filter(exp => !(max && exp.total > max))
            .filter(exp => {
              return status && status.length > 0 ? status.indexOf(exp.status) >= 0 : false;
            })
            .filter(exp => {
              return start && helpers.isValid(start) ? helpers.isAfter(exp.date, start) : true;
            })
            .filter(exp => {
              return end && helpers.isValid(end) ? helpers.isBefore(exp.date, end) : true;
            });
        else
          return {};
      });*/


    const total = 0; /*Reselect.createSelector([getExpenses], expenses => {
      return expenses
        .filter(exp => exp.status === 'ok')
        .map(exp => exp.total)
        .reduce((sum, current) => sum + current, 0)
        .toFixed(2);
    });*/

    const merchants = {} /*Reselect.createSelector([getExpenses], expenses => {
      return expenses
        .map(e => e.merchant)
        .filter((val, index, self) => self.indexOf(val) === index);
    });*/

    const appliedFilters = 0 /*Reselect.createSelector([getFilters], filters => {
      let numFilters = 0;

      Object.keys(filters).forEach(f => {
        const filter = filters[f];
        if (filter) {
          if (Array.isArray(filter)) {
            numFilters += ExpenseManager.constants.statuses.length - filter.length;
          } else {
            numFilters++;
          }
        }
      });
      return numFilters;
    });*/
    
    const vouchers_group = Reselect.createSelector(
      [getVouchers],
      (vouchers) => {
          let vouch_arr = []
          for(var v in vouchers) 
            {
              vouch_arr.push(vouchers[v]['voucherType'])
            }
          let voucherCount = vouch_arr.
                  reduce( (tmp, key) => {
                      if (! tmp[key])
                        tmp[key]= 1;
                      else
                        tmp[key]++;

                      return tmp;
                  }, {});
          
          var string_count = "";

          for (var i in voucherCount){
              if (string_count!= "")
                string_count += " & ";
              string_count += `${voucherCount[i]} ${i} `;
          }

          return string_count;

    });

    const total_discount = Reselect.createSelector(
      [getVouchers], vouchers => {
      return vouchers
        // .filter(exp => exp.status === 'ok')
        .map(vouch => vouch.voucherAmount)
        .reduce((sum, current) => sum + current, 0)
    });

    window.ExpenseManager = window.ExpenseManager || {};
    window.ExpenseManager.select = {
      expenses,
      merchants,
      appliedFilters,
      total,
      vouchers_group,
      total_discount
    };
  })();

</script>
