<link rel="import" href="constants.html">
<script src="../../node_modules/reselect/dist/reselect.js"></script>
<link rel="import" href="../date-helpers.html">

<script>
  (() => {

    const getExpenses = state => state.expenses.expenses;
    const getFilters = state => state.filters.filters;
    const getVouchers = state => state.lastTrx.vouchers;
    const getTrxAmount = state => state.lastTrx.trxAmount;
    const getTransaction = state => state.transaction;
    const getUserDetails = state => state.user.data;
    const getList = state => state.burned;

    const helpers = ExpenseManager.dateHelpers;

    const expenses = 0/*Reselect.createSelector(
      [getExpenses, getFilters],
      (expenses, filters) => {

        const merchant = filters.merchant;
        const min = filters.min;
        const max = filters.max;
        const status = filters.status;
        const start = filters.start;
        const end = filters.end;
        
        if (expenses.length!=0)
          return expenses
            .filter(exp => !(merchant && exp.merchant.toUpperCase().indexOf(merchant.toUpperCase()) < 0))
            .filter(exp => !(min && exp.total < min))
            .filter(exp => !(max && exp.total > max))
            .filter(exp => {
              return status && status.length > 0 ? status.indexOf(exp.status) >= 0 : false;
            })
            .filter(exp => {
              return start && helpers.isValid(start) ? helpers.isAfter(exp.date, start) : true;
            })
            .filter(exp => {
              return end && helpers.isValid(end) ? helpers.isBefore(exp.date, end) : true;
            });
        else
          return {};
      });*/


    const total = 0; /*Reselect.createSelector([getExpenses], expenses => {
      return expenses
        .filter(exp => exp.status === 'ok')
        .map(exp => exp.total)
        .reduce((sum, current) => sum + current, 0)
        .toFixed(2);
    });*/

    const merchants = {} /*Reselect.createSelector([getExpenses], expenses => {
      return expenses
        .map(e => e.merchant)
        .filter((val, index, self) => self.indexOf(val) === index);
    });*/

    const appliedFilters = 0 /*Reselect.createSelector([getFilters], filters => {
      let numFilters = 0;

      Object.keys(filters).forEach(f => {
        const filter = filters[f];
        if (filter) {
          if (Array.isArray(filter)) {
            numFilters += ExpenseManager.constants.statuses.length - filter.length;
          } else {
            numFilters++;
          }
        }
      });
      return numFilters;
    });*/
    
    const vouchers_group = Reselect.createSelector(
      [getVouchers,getTrxAmount,getTransaction,getUserDetails],
      (vouchers,orig_amount) => {
          let vouch_arr = []
          for(var v in vouchers) 
            {
              vouch_arr.push({
                voucherType: vouchers[v]['voucherType'],
                voucherAmount: vouchers[v]['voucherAmount']
              })
            }
          
            let voucherCount = vouch_arr.
                  reduce( (tmp, key) => {
                      var {voucherType, voucherAmount} = key 
                      
                      if(tmp.vouchers.length == 0 )
                        tmp.remainingAmount = tmp.txAmount
                      else
                        tmp.remainingAmount = tmp.remainingAmount - voucherAmount;

                      // check if it has been indexed before..
                      if (! tmp[voucherType]){
                        tmp[voucherType]= 1;
                        
                        tmp['vouchers'].push({
                          voucherType: voucherType,
                          voucherAmount: voucherAmount,
                          qty: 1,
                          // original: 
                          // remaining: tmp.txAmount
                        })
                      }
                      else { // new entry of voucher Type
                        tmp[voucherType]++;
                        
                        // find the index that we want to change
                        var idx;
                        for (var i in tmp['vouchers'])
                        {
                          if (tmp['vouchers'][i]['voucherType']==voucherType)
                            idx = i;
                        }
                        tmp['vouchers'][idx]['qty'] = tmp['vouchers'][idx]['qty']+1;
                        // tmp['vouchers'][idx]['remaining'] = tmp.txAmount;


                      }
                      return tmp;
                  }, {txAmount: orig_amount, vouchers:[]});
          
          // var string_count = "";

          // for (var i in voucherCount){
          //     if (string_count!= "")
          //       string_count += " & ";
          //     string_count += `${voucherCount[i]} ${i} `;
          // }
          
          var voucherGroupSorted = voucherCount.vouchers;
          for (var i in voucherGroupSorted){
              if (i==0)
                voucherGroupSorted[i]['original'] = orig_amount;
              else
                voucherGroupSorted[i]['original'] = voucherGroupSorted[i-1]['remaining'] 

              voucherGroupSorted[i]['discount'] = voucherGroupSorted[i]['voucherAmount'] * voucherGroupSorted[i]['qty'] ;
              voucherGroupSorted[i]['remaining'] = voucherGroupSorted[i]['original'] - voucherGroupSorted[i]['discount'];
   
              voucherGroupSorted[i]['original'] = decimalize(voucherGroupSorted[i]['original'])
              voucherGroupSorted[i]['discount'] = decimalize(voucherGroupSorted[i]['discount'])
              voucherGroupSorted[i]['remaining'] = decimalize(voucherGroupSorted[i]['remaining'])
          }

          return voucherGroupSorted;

    });
    
    var decimalize = function(numbers){
      return numeral(numbers).format(0.0);
    }

    const total_discount = Reselect.createSelector(
      [getVouchers], vouchers => {
      return vouchers
        // .filter(exp => exp.status === 'ok')
        .map(vouch => vouch.voucherAmount)
        .reduce((sum, current) => sum + current, 0)
    });

    const listVouchers = Reselect.createSelector(
      [getList, getFilters],
      (burned, filters) => {

        const min = filters.min;
        const max = filters.max;
        // const status = filters.status;
        const start = filters.start;
        const end = filters.end;
        
        if (burned.length!=0)
          return burned
            // .filter(list => !(merchant && list.merchant.toUpperCase().indexOf(merchant.toUpperCase()) < 0))
            .filter(burned => !(min && burned.txnOriginalAmount < min))
            .filter(burned => !(max && burned.txnOriginalAmount > max))
            // .filter(burned => {
            //   return status && status.length > 0 ? status.indexOf(burned.status) >= 0 : false;
            // })
            .filter(burned => {
              return start && helpers.isValid(start) ? helpers.isAfter(helpers.format(burned.txnTransactionDate), start) : true;
            })
            .filter(burned => {
              return end && helpers.isValid(end) ? helpers.isBefore(helpers.format(burned.txnTransactionDate), end) : true;
            });
        else
          return {};
      });

    window.ExpenseManager = window.ExpenseManager || {};
    window.ExpenseManager.select = {
      expenses,
      merchants,
      appliedFilters,
      total,
      vouchers_group,
      total_discount,
      listVouchers
    };
  })();

</script>
