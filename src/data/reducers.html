<script src="../../node_modules/redux/dist/redux.min.js"></script>
<link rel="import" href="../date-helpers.html">

<script>
  (() => {

    let boom = {};
    _generateDemoExpensesAsync().then(
        result => boom = result);

    const helpers = window.ExpenseManager.dateHelpers;

    let savedState = localStorage.getItem('ExpenseManagerState');
    if (savedState) {
      savedState = JSON.parse(savedState);
    }


    function uiReducer(state = {
      authenticated: savedState ? savedState.uiState.authenticated : false,
      infoDialogVisible: false
    }, action) {
      switch (action.type) {

        case 'LOGIN':
          return Object.assign({}, state, {authenticated: true});

        case 'LOGOUT':
          return Object.assign({}, state, {authenticated: false});

        case 'SHOW_INFO_DIALOG':
          return Object.assign({}, state, {infoDialogVisible: true});

        case 'HIDE_INFO_DIALOG':
          return Object.assign({}, state, {infoDialogVisible: false});

        default:
          return state;
      }
    }

/* ATTEMPTING to AWAIT the beginning of expensesReducer */
    async function expensesReducerSynchronous(state,action) {
      
      let temp_state = new Object();
      _generateDemoExpenses(100).then(results => 
        temp_state.expenses = results)
      
      temp_state.selectedExpense = undefined ;

      //continue follow-up to the 'Original' expensedReducer..
      expensesReducer(temp_state, action)
    }

    function vouchersReducer( state ={ 
        trxNumber: uuid(),
        trxAmount: '',
        validTrx: false,
        trxProcess: false,
        vouchers: [
        {
                'id': 0,
                'uniqueCode': '            ',
                'voucherType': ' Go-deals 25k  ',
                'voucherDetail': '',
                'voucherAmount': '',
                'voucherEligible': false,
                'onCheck': false,
                'errorCode': '',
                'errorMsg': ''
              },
              // {
              //   'id': 1,
              //   'uniqueCode': '121287366128',
              //   'voucherType': ' Go-deals 25k  ',
              //   'voucherDetail': '',
              //   'voucherAmount': '',
              //   'voucherEligible': true,
              //   'onCheck': false,
              //   'errorCode': '',
              //   'errorMsg': ''
              // }
        ],
        currentVoucher: {},
    }, action) {
      switch (action.type) {
          case 'ADD_VOUCHER':
            return Object.assign({}, state, {
                vouchers: state.vouchers.concat(action.new_voucher),
                currentVoucher: undefined
            });

          case 'REMOVE_VOUCHER':
              return Object.assign({}, state, {
                vouchers: state.vouchers.filter(e => e.id !== action.id),
                currentVoucher: undefined
              });
          
          case 'UPDATE_VOUCHER':
              return Object.assign({}, state, {
                vouchers: state.vouchers.map(e => {
                  return e.id === action.voucher.id ? action.voucher : e;
              })
            });
            
          case 'UPDATE_TXABLE':
              return Object.assign({}, state, {
                validTrx: action.valids
            });

          case 'UPDATE_TX_AMOUNT':
              return Object.assign({}, state, {
                trxAmount: action.amount
            });

          case 'RESET_ALL':
              return Object.assign({}, state, {
                validTrx: false,
                trxNumber: uuid(),
                vouchers: [
                  {
                      'id': 0,
                      'uniqueCode': '            ',
                      'voucherType': ' Go-deals 25k  ',
                      'voucherDetail': '',
                      'voucherAmount': '',
                      'voucherEligible': false,
                      'onCheck': false,
                      'errorCode': '',
                      'errorMsg': ''
                   },
                ],
                trxAmount: ''
            });

          default:
              return state;
      }
    }

    function expensesReducer(//state = {
      /* 
      expenses: savedState ? savedState.expenses.expenses : _generateDemoExpenses(100),
      */
    //   expenses: _generateDemoExpenses(100),
    //   selectedExpense: undefined
    // }, action) {
    state= {expenses: boom, selectedExpense: undefined}, action) {
      switch (action.type) {

        case 'EDIT_EXPENSE':
          return Object.assign({}, state, {selectedExpense: action.expense});

        case 'UPDATE_EXPENSE':
          return Object.assign({}, state, {
            expenses: state.expenses.map(e => {
              return e.id === action.expense.id ? action.expense : e;
            }),
            selectedExpense: undefined
          });

        case 'ADD_EXPENSE': // Push new `expenses`, then clear currentselected expenses
          return Object.assign({}, state, {
            expenses: state.expenses.concat(action.expense),
            selectedExpense: undefined
          });

        case 'DELETE_EXPENSE':
          return Object.assign({}, state, {
            expenses: state.expenses.filter(e => e.id !== action.expense.id),
            selectedExpense: undefined
          });

        case 'CANCEL_EDIT':
          return Object.assign({}, state, {selectedExpense: undefined});

        default:
          return state;
      }
    }

    function filtersReducer(state = {
      // filters: {status: ['new', 'in_progress', 'reimbursed', 'ok', 'invalid', 'already']}
    
      filters: {status: ['ok', 'failed', 'error']}
    }, action) {
      switch (action.type) {

        case 'TOGGLE_FILTERS':
          return Object.assign({}, state, {filtersVisible: !state.filtersVisible});

        case 'HIDE_FILTERS':
          return Object.assign({}, state, {filtersVisible: false});

        case 'FILTERS_UPDATED':
          return Object.assign({}, state, {filters: action.filters});

        case 'CLEAR_FILTERS':
          return Object.assign({}, state, {
            filters: {status: ['new', 'in_progress', 'reimbursed']}
          });

        default:
          return state;
      }
    }
    
console.log(boom)

    window.ExpenseManager = window.ExpenseManager || {};
    window.ExpenseManager.rootReducer = Redux.combineReducers({
      uiState: uiReducer,
      expenses: expensesReducer,
      vouchers: vouchersReducer,
      filters: filtersReducer
    });


    // No-dependency UUID generator https://gist.github.com/jed/982883, good enough for this demo
    function uuid() {
      return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, a => (a ^ Math.random() * 16 >> a / 4).toString(16));
    }

    function _generateDemoExpensesAsyncHandler() {
      return _generateDemoExpensesAsync().then(result => {return result});
    }

    async function _generateDemoExpensesAsync(num) {
    //  return new Promise ( resolve => {
      let {content} = await _computeData();

      const expenses = [];
      const now = Date.now();
      for (let i = 0; i < content.length; i++) {
        const date = helpers.subtract(now, 'hours', Math.floor(Math.random() * 168) + 1);
        
        tempstat = content[i].txnResponseDetail
        
        if (tempstat == "Voucher Already Redeemed.") {
          status = 'error';
        } else if (tempstat == "Approved.") {
          status = 'ok';
        
        } else if (tempstat == "Invalid Voucher Code.") {
          status = 'failed';
        }
        
        expenses.push({
          id: uuid(),
          date: (new Date(date.getTime() - date.getTimezoneOffset() * 60000)).toISOString().split('T')[0],
          merchant: content[i].txnMerchantName==''? "(undefined)" : content[i].txnMerchantName, 
          total: content[i].txnOriginalAmount,
          status: status,
          receipt: status === 'new' ? '' : 'images/default-receipt.png',
          comment: content[i].txnResponseDetail
        });
      }
      console.log(expenses)
      return expenses;
    //  });
    }

    function _generateDemoExpenses(num) {
    //  return new Promise ( resolve => {
      
      const expenses = [];
      const now = Date.now();
      for (let i = 0; i < num; i++) {
        const date = helpers.subtract(now, 'hours', Math.floor(Math.random() * 168) + 1);
        var status = 'new';
        if (i > 10) {
          status = 'reimbursed';
        } else if (i > 5) {
          status = 'in_progress';
        }
        expenses.push({
          id: uuid(),
          date: (new Date(date.getTime() - date.getTimezoneOffset() * 60000)).toISOString().split('T')[0],
          merchant: [
            'Office supplies', 'Electronics'
          ][Math.floor(Math.random() * 2)],
          total: _getRandomPrice,
          status: status,
          receipt: status === 'new' ? '' : 'images/default-receipt.png',
          comment: "Detailss......."
        });
      }

      return expenses;
    //  });
    }

    function _getRandomPrice() {
      const price = Math.random() * (Math.random() * 3) * 300 + 10;
      return parseFloat(price.toFixed(2));
    }

    function _computeData() {
      return new Promise(resolve => {
        _getResource( {
            url: './src/data/manual-redeem.json',
            onLoad(e){
                //this.set('expenses', JSON.parse(e.target.responseText));
                //return JSON.parse(e.target.responseText)
                resolve (JSON.parse(e.target.responseText));

            }
        })
      });
    }

    function _getResource(rq) {
      let xhr = new XMLHttpRequest();
      xhr.addEventListener('load', rq.onLoad.bind(this));
      xhr.open('GET', rq.url);xhr.send();
    }
        

  })();

</script>
