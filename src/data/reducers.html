<script src="../../node_modules/redux/dist/redux.min.js"></script>
<link rel="import" href="../date-helpers.html">

<script>
  (() => {

    // let boom = {"content":[{"txnLogId":3520,"txnTransactionDate":"11-05-2018 17:05:47","txnStartTransactionDate":null,"txnEndTransactionDate":null,"txnTransactionType":"Manual Redeem","txnInstitutionCode":null,"txnInstitutionName":null,"txnMerchantCode":"","txnMerchantName":"","txnStoreCode":"","txnStoreName":"","txnMid":"GOCAFE000000001","txnTid":"GOCAFE01","txnMaskedNumber":null,"txnTokenNumber":null,"txnCardNumber":null,"txnUniqueCode":"73255656532","txnOriginalAmount":250000.0,"txnRemainingAmount":250000.0,"txnTraceNumber":"000153","txnReversalFlag":false,"txnResponseCode":"B2","txnResponseDetail":"Invalid Voucher Code.","txnTimezone":"GMT+7","txnAdditionalInfo":null,"txnVoucherName":null,"storeCode":null,"storeName":null,"txnLogDetails":[{"txnLogDetailId":3029,"txnLogId":null,"txnInstitutionCode":null,"txnInstitutionName":null,"txnTransactionDate":1526033147000,"txnAdjustedAmount":250000.0,"txnRedeemRewardId":null,"txnRedeemType":null,"txnRedeemCode":null,"txnRedeemLabel":null,"txnRedeemValue":null,"txnRedeemExpired":null,"txnRedeemQty":1,"txnRewardCampaignId":null,"txnRewardCampaignLabel":null,"txnRewardId":null,"txnRewardType":null,"txnRewardCode":null,"txnRewardLabel":null,"txnRewardValue":null,"txnRewardExpired":null,"txnRewardQty":null,"txnRewardTag":null,"txnRewardMessage":null,"status":null,"txnAdditionalInfo":null}]}]};
    // _generateDemoExpensesAsync().then(
    //     result => boom = result);

    const helpers = window.ExpenseManager.dateHelpers;

    // localStorage.setItem('ls.authorizationData', '{"username":"yomama","fullname":"isfet","email":"yo@mama","phone":"08787878787","roleCode":"SPA","roleName":"SuperAdmin","groupCode":"99999999999","groupName":"Kartuku1","groupType":"Owner","parentCode":"99999999999","parentName":"Kartuku1","menu":[{"code":"group","name":"Group Management","parent":"User and Role","sortNo":"11","url":"app.group"},{"code":"role","name":"Role Management","parent":"User and Role","sortNo":"12","url":"app.role"},{"code":"user","name":"User Management","parent":"User and Role","sortNo":"13","url":"app.user"},{"code":"institution","name":"Institution Management","parent":"Institution and Merchant","sortNo":"31","url":"app.institution"},{"code":"merchant","name":"Merchant Management","parent":"Institution and Merchant","sortNo":"32","url":"app.merchant"},{"code":"store","name":"Store Management","parent":"Institution and Merchant","sortNo":"33","url":"app.store"},{"code":"account","name":"Account Management","parent":"Account and Card","sortNo":"41","url":"app.account"},{"code":"card-bin","name":"Card BIN Management","parent":"Account and Card","sortNo":"42","url":"app.card-bin"},{"code":"reward","name":"Reward Management","parent":"Reward","sortNo":"51","url":"app.reward"},{"code":"rewardinfo","name":"Reward Info","parent":"Reward","sortNo":"52","url":"app.rewardinfo"},{"code":"rewards-transfer","name":"Transfer Rewards","parent":"Reward","sortNo":"53","url":"app.rewards-transfer"},{"code":"generate-code","name":"Generate Rewards Code","parent":"Reward","sortNo":"54","url":"app.generate-code"},{"code":"import-rewards","name":"Upload Rewards Code","parent":"Reward","sortNo":"55","url":"app.import-rewards"},{"code":"basic-campaign","name":"Basic Campaign","parent":"Campaign Management","sortNo":"61","url":"app.basic-campaign"},{"code":"campaign-simulator","name":"Campaign Simulator","parent":"Campaign Management","sortNo":"62","url":"app.campaign-simulator"},{"code":"transaction-report","name":"Transaction Report","parent":"Report","sortNo":"71","url":"app.transaction-report"},{"code":"manualredeem-report","name":"Manual Redeem Report","parent":"Report","sortNo":"72","url":"app.manualredeem-report"},{"code":"manualredeem","name":"Manual Redeem","parent":"Web POS","sortNo":"81","url":"app.manualredeem"},{"code":"webpos-report","name":"Web POS Report","parent":"Web POS","sortNo":"82","url":"app.webpos-report"}],"task":[{"code":"transaction-report_update","name":"transaction-report_update"},{"code":"import-rewards_create","name":"import-rewards_create"},{"code":"generate-code_create","name":"generate-code_create"},{"code":"institution_update","name":"institution_update"},{"code":"role_delete","name":"role_delete"},{"code":"institution_read","name":"institution_read"},{"code":"store_create","name":"store_create"},{"code":"merchant_delete","name":"merchant_delete"},{"code":"manualredeem-report_read","name":"manualredeem-report_read"},{"code":"institution_delete","name":"institution_delete"},{"code":"basic-campaign_update","name":"basic-campaign_update"},{"code":"basic-campaign_approve","name":"basic-campaign_approve"},{"code":"user_create","name":"user_create"},{"code":"generate-code_read","name":"generate-code_read"},{"code":"merchant_update","name":"merchant_update"},{"code":"role_read","name":"role_read"},{"code":"account_read","name":"account_read"},{"code":"card-bin_read","name":"card-bin_read"},{"code":"store_read","name":"store_read"},{"code":"manualredeem-report_update","name":"manualredeem-report_update"},{"code":"card-bin_delete","name":"card-bin_delete"},{"code":"account_update","name":"account_update"},{"code":"store_delete","name":"store_delete"},{"code":"group_update","name":"group_update"},{"code":"role_create","name":"role_create"},{"code":"card-bin_create","name":"card-bin_create"},{"code":"basic-campaign_read","name":"basic-campaign_read"},{"code":"merchant_create","name":"merchant_create"},{"code":"user_read","name":"user_read"},{"code":"reward_read","name":"reward_read"},{"code":"basic-campaign_delete","name":"basic-campaign_delete"},{"code":"group_create","name":"group_create"},{"code":"role_update","name":"role_update"},{"code":"transaction-report_read","name":"transaction-report_read"},{"code":"import-rewards_read","name":"import-rewards_read"},{"code":"reward_update","name":"reward_update"},{"code":"campaign-simulator_create","name":"campaign-simulator_create"},{"code":"reward_create","name":"reward_create"},{"code":"rewards-transfer_delete","name":"rewards-transfer_delete"},{"code":"basic-campaign_create","name":"basic-campaign_create"},{"code":"rewards-transfer_update","name":"rewards-transfer_update"},{"code":"store_update","name":"store_update"},{"code":"merchant_read","name":"merchant_read"},{"code":"user_update","name":"user_update"},{"code":"group_delete","name":"group_delete"},{"code":"user_delete","name":"user_delete"},{"code":"reward_delete","name":"reward_delete"},{"code":"rewards-transfer_read","name":"rewards-transfer_read"},{"code":"group_read","name":"group_read"},{"code":"institution_create","name":"institution_create"},{"code":"rewards-transfer_create","name":"rewards-transfer_create"},{"code":"card-bin_update","name":"card-bin_update"},{"code":"rewardinfo_read","name":"rewardinfo_read"},{"code":"manualredeem_create","name":"manualredeem_create"},{"code":"webpos-report_read","name":"webpos-report_read"}]}');

    /* for DEV only! REMEMBER TO COMMENT */
    // localStorage.setItem('ls.cashierData', '{"username":"jono_cashier","jsessionid":"ZFbCLh9C0LPK5Ktm0nVqDgm9DWl8KK","groupCode":"00000738473","storeCode":"JONO01","storeName":"Jono barber shop Flamboyan","merchantCode":"00000738473","merchantName":"Jono Barber shop","mid":"000001121530000","tid":"11120860"}');

    // localStorage.setItem('ls.cashierData', '{"username":"jono_cashier","jsessionid":"4AVleXJzLBsC1qLYHkl8DqGQfxx5zK","groupCode":"00000738473","storeCode":"ARLP_SOETTA","storeName":"Jono barber shop Flamboyan","merchantCode":"00000066666","merchantName":"Jono Barber shop","mid":"FR704LGI1PPC9G2","tid":"YMWS3EG2"}');

    let savedState = localStorage.getItem('ExpenseManagerState');
    let authState = localStorage.getItem('ls.cashierData');

    if (savedState) {
      savedState = JSON.parse(savedState);
    }
    if (authState) {
      authState = JSON.parse(authState)
    }

    function uiReducer(state = {
      authenticated: savedState ? savedState.uiState.authenticated : false,
      activePage: '',
      receiptDialogVisible: false,
      REreceiptDialogVisible: false,
      pagination: 0,
      page_loading: false,
      modalAlert: false,
      connectionAttempt: 0
    }, action) {
      switch (action.type) {

        case 'LOGIN':
          return Object.assign({}, state, {authenticated: true});

        case 'LOGOUT':
          return Object.assign({}, state, {authenticated: false});

        case 'SHOW_INFO_DIALOG':
          return Object.assign({}, state, {infoDialogVisible: true});

        case 'HIDE_INFO_DIALOG':
          return Object.assign({}, state, {infoDialogVisible: false});

        case 'SHOW_RECEIPT':
          return Object.assign({}, state, {receiptDialogVisible: true});
        
        case 'HIDE_RECEIPT':
          return Object.assign({}, state, {receiptDialogVisible: false});
        
        case 'SHOW_RERECEIPT':
          return Object.assign({}, state, {REreceiptDialogVisible: true});
        
        case 'HIDE_RERECEIPT':
          return Object.assign({}, state, {REreceiptDialogVisible: false});

        case 'SWITCH_PAGE':
          return Object.assign({}, state, {activePage: action.page});
        
        case 'PAGE_INCREASE':
          return Object.assign({}, state, {pagination: state.pagination+1});

        case 'SHOW_SMILEY_DIALOG':
          return Object.assign({}, state, {modalAlert: true});
        
        case 'HIDE_SMILEY_DIALOG':
          return Object.assign({}, state, {modalAlert: false});
        
        case 'ADD_CONN_ATTEMPT':
          return Object.assign({}, state, {connectionAttempt: state.connectionAttempt + 1});
        
        case 'RESET_CONN_ATTEMPT':
          return Object.assign({}, state, {connectionAttempt: 0});
        
        default:
          return state;
      }
    }

/* ATTEMPTING to AWAIT the beginning of expensesReducer 
    async function expensesReducerSynchronous(state,action) {
      
      let temp_state = new Object();
      _generateDemoExpenses(100).then(results => 
        temp_state.expenses = results)
      
      temp_state.selectedExpense = undefined ;

      //continue follow-up to the 'Original' expensedReducer..
      expensesReducer(temp_state, action)
    }
*/
    function lastTxReducer( state = { 
        trxNumber: txid(),
        trxAmount: 150000,
        remaining: 125000,
        validTrx: false,
        trxProcess: false,
        vouchers: [
        {
                'id': 0,
                'uniqueCode': '            ',
                'voucherType': 'Voucher Gopay 25k',
                'voucherDetail': '',
                'voucherAmount': 25000,
                'voucherEligible': false,
                'onCheck': false,
                'errorCode': '',
                'errorMsg': '',
                'available': false
              },
        ],
        currentVoucher: {},
    }, action) {
      switch (action.type) {
          case 'APPEND_TX':
            return action.trx
          
          default:
            return state;
      }
    }
        
    function transactionReducer( state = {
        trxNumber: txid(),
        trxAmount: '',
        remaining: '',
        validTrx: false,
        trxProcess: false,
        array_example: [
                    {id: 0},
                    {id: 1},
                    {id: 2},
                    {id: 3},
                    {id: 4},
                    {id: 5},
                    {id: 6},
                    {id: 7},
                  ]
      }, action){
        switch (action.type) {
          case 'UPDATE_TXABLE':
              return Object.assign({}, state, {
                validTrx: action.valids
            });

          case 'UPDATE_TX_AMOUNT':
              return Object.assign({}, state, {
                trxAmount: action.amount,
            });

          case 'UPDATE_REMAINING':
              return Object.assign({}, state, {
                remaining: action.amt
            });

          case 'TEST_REMOVE':
              return Object.assign({},
              state, {
                array_example: [
                    {id: 0},
                    {id: 1},
                    {id: 3},
                    {id: 4},
                    {id: 5},
                    {id: 6},
                    {id: 7},
                    {id: 8},
                  ]
              })

          case 'RESET_TX':
              return Object.assign({}, state, {
                validTrx: false,
                trxNumber: txid(),
                trxAmount: '',
                remaining: '0'
            });
          
          default:
            return state;
        }
      }
    
    function vouchersReducer( state ={
        vouchers: [
        {
                'id': 0,
                'uniqueCode': '',
                'voucherType': ' Go-deals 25k  ',
                'voucherDetail': '',
                'voucherAmount': '',
                'voucherEligible': false,
                'onCheck': false,
                'errorCode': '',
                'errorMsg': '',
                'available': false,
                'shake':false,
                'unchecked': false // when connection error and couldnt do eligible check
              },
        ],
        currentVoucher: {},
    }, action) {
      switch (action.type) {
          case 'ADD_VOUCHER':
            return Object.assign({}, state, {
                vouchers: state.vouchers.concat(action.new_voucher),
                currentVoucher: undefined
            });

          case 'REMOVE_VOUCHER':
              return Object.assign({}, state, {
                vouchers: state.vouchers.filter(e => e.id !== action.id),
                currentVoucher: undefined
              });
          
          case 'UPDATE_VOUCHER':
              return Object.assign({}, state, {
                vouchers: state.vouchers.map(e => {
                  return e.id === action.voucher.id ? action.voucher : e;
              })
            });

          case 'RESET_ALL':
              return Object.assign({}, state, {
                vouchers: [
                  {
                      'id': 0,
                      'uniqueCode': '',
                      'voucherType': ' Go-deals 25k  ',
                      'voucherDetail': '',
                      'voucherAmount': '',
                      'voucherEligible': false,
                      'onCheck': false,
                      'errorCode': '',
                      'errorMsg': '',
                      'shake': false
                  }
                ]
            });

          default:
              return state;
      }
    }

  function userReducer( state ={ 
      data: {
        username: authState.username,
        groupCode: authState.groupCode,
        storeCode: authState.storeCode,
        storeName: authState.storeName,
        merchantCode: authState.merchantCode,
        merchantName: authState.merchantName,
        mid: authState.mid,
        tid: authState.tid,
      },
      session: {
        jsess: authState.jsessionid,
        authTime: Date.now()
      }
    }, action) {
      switch (action.type) {
          case 'LOGGING_IN':
            return Object.assign({}, state, {
                data: action.user.details,
                session: action.user.session
            });

          case 'LOGGING_OUT':
              return Object.assign({}, state, {
                session: ''
              });
          
          case 'UPDATE_SESSION':
              return Object.assign({}, state, {
                session: action.new_session
            });

          default:
              return state;
      }
    }
    
  function errorsReducer( state={ 
      msg: null,
      code: null
    }, action) {
      switch (action.type) {
          case 'UPDATE_ERROR_CODE':
            return Object.assign({}, state, {
                code: action.code
            });

          case 'UPDATE_ERROR_MSG':
            return Object.assign({}, state, {
                msg: action.msg
            });

          default:
              return state;
      }
    }

  function burnedReducer( state=[], action) {
      switch (action.type) {
          case 'APPEND_BURNED_LIST': {
           var temp = [];
           for(var i=0; i<state.length;i++)
              temp.push(state[i])

           var newStuff = action.lists;
           for(var j=0; j<newStuff.length;j++)
              temp.push(newStuff[j]);
           
           return temp;
          } 

          case 'FRESH_BURNED_LIST':
            return action.lists

          default:
              return state;
      }
    }

  function expensesReducer(//state = {
      /* 
      expenses: savedState ? savedState.expenses.expenses : _generateDemoExpenses(100),
      */
    //   expenses: _generateDemoExpenses(100),
    //   selectedExpense: undefined
    // }, action) {
    state= {expenses: {}, 
        selectedExpense: undefined}, action) {
      switch (action.type) {

        case 'EDIT_EXPENSE':
          return Object.assign({}, state, {selectedExpense: action.expense});

        case 'UPDATE_EXPENSE':
          return Object.assign({}, state, {
            expenses: state.expenses.map(e => {
              return e.id === action.expense.id ? action.expense : e;
            }),
            selectedExpense: undefined
          });

        case 'ADD_EXPENSE': // Push new `expenses`, then clear currentselected expenses
          return Object.assign({}, state, {
            expenses: state.expenses.concat(action.expense),
            selectedExpense: undefined
          });

        case 'DELETE_EXPENSE':
          return Object.assign({}, state, {
            expenses: state.expenses.filter(e => e.id !== action.expense.id),
            selectedExpense: undefined
          });

        case 'CANCEL_EDIT':
          return Object.assign({}, state, {selectedExpense: undefined});

        default:
          return state;
      }
    }

    function filtersReducer(state = {
      // filters: {status: ['new', 'in_progress', 'reimbursed', 'ok', 'invalid', 'already']}
      specificVoucher: '',
      filters: {status: ['ok', 'failed', 'error']},
      applyUpdate: false
    }, action) {
      switch (action.type) {

        case 'TOGGLE_FILTERS':
          return Object.assign({}, state, {filtersVisible: !state.filtersVisible});

        case 'HIDE_FILTERS':
          return Object.assign({}, state, {filtersVisible: false});

        case 'FILTERS_UPDATED':
          return Object.assign({}, state, {filters: action.filters});

        case 'CLEAR_FILTERS':
          return Object.assign({}, state, {
            filters: {
                status: ['new', 'in_progress', 'reimbursed'],
                txnTraceNumber: ''      
            }
          });
        
        case 'SEARCH_VOUCHER':
          return Object.assign({}, state, {
            specificVoucher: action.voucher
          });
        
        case 'UPDATE_REQUEST':
          return Object.assign({}, state, {applyUpdate: true});
        
        case 'UPDATE_DONE':
          return Object.assign({}, state, {applyUpdate: false});

        default:
          return state;
      }
    }

    window.ExpenseManager = window.ExpenseManager || {};
    window.ExpenseManager.rootReducer = Redux.combineReducers({
      uiState: uiReducer,
      expenses: expensesReducer,
      vouchers: vouchersReducer,
      transaction: transactionReducer,
      lastTrx: lastTxReducer,
      errors: errorsReducer,
      filters: filtersReducer,
      user: userReducer,
      burned: burnedReducer
    });


    // No-dependency UUID generator https://gist.github.com/jed/982883, good enough for this demo
    function uuid() {
      return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, a => (a ^ Math.random() * 16 >> a / 4).toString(16));
    }

    function hashCode(str){
        var hash = 0;
        if (str.length == 0) return hash;
        for (i = 0; i < str.length; i++) {
            char = str.charCodeAt(i);
            hash = ((hash<<5)-hash)+char;
            hash = hash & hash; // Convert to 32bit integer
        }
        return hash;
    }
    function txid() {
      var _tgl = new Date().getTime().toString()
      return hashCode(_tgl);
    }

    function _generateDemoExpensesAsyncHandler() {
      return _generateDemoExpensesAsync().then(result => {return result});
    }

   /*
   async function _generateDemoExpensesAsync(num) {
    //  return new Promise ( resolve => {
      let {content} = await _computeData();

      const expenses = [];
      const now = Date.now();
      for (let i = 0; i < content.length; i++) {
        const date = helpers.subtract(now, 'hours', Math.floor(Math.random() * 168) + 1);
        
        tempstat = content[i].txnResponseDetail
        
        if (tempstat == "Voucher Already Redeemed.") {
          status = 'error';
        } else if (tempstat == "Approved.") {
          status = 'ok';
        
        } else if (tempstat == "Invalid Voucher Code.") {
          status = 'failed';
        }
        
        expenses.push({
          id: uuid(),
          date: (new Date(date.getTime() - date.getTimezoneOffset() * 60000)).toISOString().split('T')[0],
          merchant: content[i].txnMerchantName==''? "(undefined)" : content[i].txnMerchantName, 
          total: content[i].txnOriginalAmount,
          status: status,
          receipt: status === 'new' ? '' : 'images/default-receipt.png',
          comment: content[i].txnResponseDetail
        });
      }
      console.log(expenses)
      return expenses;
    //  });
    }
*/
    function _generateDemoExpenses(num) {
    //  return new Promise ( resolve => {
      
      const expenses = [];
      const now = Date.now();
      for (let i = 0; i < num; i++) {
        const date = helpers.subtract(now, 'hours', Math.floor(Math.random() * 168) + 1);
        var status = 'new';
        if (i > 10) {
          status = 'reimbursed';
        } else if (i > 5) {
          status = 'in_progress';
        }
        expenses.push({
          id: uuid(),
          date: (new Date(date.getTime() - date.getTimezoneOffset() * 60000)).toISOString().split('T')[0],
          merchant: [
            'Office supplies', 'Electronics'
          ][Math.floor(Math.random() * 2)],
          total: _getRandomPrice,
          status: status,
          receipt: status === 'new' ? '' : 'images/default-receipt.png',
          comment: "Detailss......."
        });
      }

      return expenses;
    //  });
    }

    function _getRandomPrice() {
      const price = Math.random() * (Math.random() * 3) * 300 + 10;
      return parseFloat(price.toFixed(2));
    }

    function _computeData() {
      return new Promise(resolve => {
        _getResource( {
            url: './src/data/manual-redeem.json',
            onLoad(e){
                //this.set('expenses', JSON.parse(e.target.responseText));
                //return JSON.parse(e.target.responseText)
                resolve (JSON.parse(e.target.responseText));

            }
        })
      });
    }

    function _getResource(rq) {
      let xhr = new XMLHttpRequest();
      xhr.addEventListener('load', rq.onLoad.bind(this));
      xhr.open('GET', rq.url);xhr.send();
    }
        

  })();

</script>
